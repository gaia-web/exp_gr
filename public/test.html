<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Iframe Test</title>
  </head>
  <body>
    <h1>Plugin</h1>
    <button id="sendBtn">Send Message to everyone</button>
    <p>
      <b
        >For now, testing this plugin have to make sure all clients to stay
        within the playing page and never leave.</b
      >
    </p>
    <p>
      <i
        >Note the messages sent from here is totally handled by the plugin logic
        and the host app is basically just forwarding the messages.</i
      >
    </p>

    <script type="module">
      const sendBtn = document.getElementById("sendBtn");
      let player;
      let playerMap = new Map();

      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.type) {
          case "player_info":
            console.info(`Player info: `, message.value);
            player = message.value;
            break;
          case "player_list":
            console.info(`Player list: `, message.value);
            playerMap = new Map(message.value);
            break;
          case "test":
            if (player.isHost) {
              message.to = [...playerMap.keys()].filter(
                (id) => id !== player.id && id !== message.value.sender
              );
              window.parent.postMessage(message, "*");
            }
            // to prevent blocking message
            setTimeout(() => {
              alert(
                `${
                  playerMap.get(message.value.sender) ?? "Unknown player"
                } sent: ${message.value.content}`
              );
            });
            break;
          default:
            console.info(`From host app to plugin:`, message);
            break;
        }
      });

      sendBtn.addEventListener("click", () => {
        const msg = {
          type: "test",
          to: player.isHost
            ? [...playerMap.keys()].filter((id) => id !== player.id)
            : void 0,
          value: {
            sender: player.id,
            content: prompt("Enter the message:"),
          },
        };
        window.parent.postMessage(msg, "*");
      });
    </script>

    <style>
      :root {
        --color: hsl(0, 0%, 35%);
        --background-color: hsl(0, 0%, 90%);

        font-family: Inter, system-ui, Avenir, Helvetica, Arial, sans-serif;
        color: var(--color);
        background-color: var(--background-color);

        @media (prefers-color-scheme: dark) {
          --color: hsl(0, 0%, 65%);
          --background-color: hsl(0, 0%, 10%);
        }
      }
    </style>
  </body>
</html>
